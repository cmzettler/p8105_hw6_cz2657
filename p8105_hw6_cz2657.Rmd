---
title: "Homework 6"
output: github_document
---

```{r, message=FALSE}
library(tidyverse)
library(viridis)

library(modelr)
library(mgcv)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Problem 1

```{r}
birthweight_df = 
  read_csv("data/birthweight.csv") %>% 
  mutate(babysex = as.factor(babysex), 
         babysex = fct_recode(babysex, "male" = "1", "female" = "2"),
         fincome = fincome*100, 
         frace = as.factor(frace), 
         frace = fct_recode(frace, "white" = "1", "black" = "2", "asian" = "3",
                       "puerto rican" = "4", "other" = "8"),
         malform = as.logical(malform), 
         mrace = as.factor(mrace), 
         mrace = fct_recode(mrace, "white" = "1", "black" = "2", "asian" = "3",
                       "puerto rican" = "4"))

```

Checking for missing values by grouping by factor variables to identify possible values: 

```{r}
birthweight_df %>% 
  group_by(babysex) %>% 
  summarize()

birthweight_df %>% 
  group_by(frace) %>% 
  summarize()

birthweight_df %>% 
  group_by(malform) %>% 
  summarize()

birthweight_df %>% 
  group_by(mrace) %>% 
  summarize()

birthweight_df

birthweight_df %>% 
  drop_na()

summary(birthweight_df)

```

There are no missing values based on the drop NA function 

Fitting models

I hypothesize that a few things are key drivers of a baby's birthweight. First, baby length is likely to affect birthweight significantly. Additionally, baby's head circumference could have a similar effect. I imagine that male and female babies are relatively similar in weight, so I doubt that baby's sex has much of an effect. Mother's weight gain during pregnancy could also be an indicator of baby's weight, as well as the number of previous low birthweight babies for women who have had children prior. 

```{r}
birthweight_df %>% 
  ggplot(aes(x = blength, y = bwt)) +
  geom_point()
# baby length appears to increase with increasing birthweight 

birthweight_df %>% 
  ggplot(aes(x = bhead, y = bwt)) +
  geom_point(alpha = 0.3)
# baby head circumference also appears to increase with increasing birthweight 

birthweight_df %>% 
  ggplot(aes(x = babysex, y = bwt)) +
  geom_point(alpha = 0.3) 
# visual inspection appears to confirm that birthweight is not meaningfully different by sex; further inspection may help to confirm this: 

birthweight_df %>% 
  group_by(babysex) %>% 
  summarize(mean_bwt = mean(bwt))
# weights differ by less than 3% so this is not likely an informative predictor

birthweight_df %>% 
  ggplot(aes(x = wtgain, y = bwt)) +
  geom_point(alpha = 0.3)
# this also doesn't appear to demonstrate a meaningful trend 

birthweight_df %>% 
  ggplot(aes(x = gaweeks, y = bwt)) +
  geom_point(alpha = 0.3)
#There does appear to be a trend here; potentially, the interaction between gestational weeks and body length could be interesting, as a baby's head is usually first to develop and is large in proportion to the rest of its body for the majority of the gestational period

birthweight_df %>% 
  ggplot(aes(x = pnumlbw, y = bwt)) +
  geom_point(alpha = 0.3)
# There appear to be no values other than 0 for this variable 

birthweight_df %>% 
  group_by(pnumlbw) %>% 
  summarize(obs = n())
# finding confirmed - variable will not be included 

fit_mine = lm(bwt ~ blength + gaweeks*bhead, data = birthweight_df)

fit_mine %>% 
  broom::tidy()

summary(fit_mine)

modelr::add_residuals(birthweight_df, fit_mine) %>% 
  add_predictions(fit_mine) %>% 
  ggplot(aes(x = pred, y = resid)) + 
  geom_point()
```

Because the residuals are all grouped together around 0, we know this is a reasonable model. 

```{r}
fit_length = lm(bwt ~ blength + gaweeks, data = birthweight_df)

summary(fit_length)

fit_interaction = lm(bwt ~ bhead*blength*babysex, data = birthweight_df)

summary(fit_interaction)

# maybe delete this? think about it 

birthweight_df %>% 
  add_predictions(fit_mine) %>% 
  ggplot(aes(x = blength, y = bwt)) + 
  geom_point(alpha = .2) + 
  geom_smooth(aes(y = pred), color = "red", se = FALSE)

birthweight_df %>% 
  add_predictions(fit_length) %>% 
  ggplot(aes(x = blength, y = bwt)) + 
  geom_point(alpha = .2) + 
  geom_smooth(aes(y = pred), color = "red", se = FALSE)

birthweight_df %>% 
  add_predictions(fit_interaction) %>% 
  ggplot(aes(x = blength, y = bwt)) + 
  geom_point(alpha = .2) + 
  geom_smooth(aes(y = pred), color = "red", se = FALSE)
```

```{r}
cv_df = 
  crossv_mc(birthweight_df, 100) %>% 
  mutate(
    train = map(train, as_tibble), 
    test = map(test, as_tibble)
  )

cv_df = 
  cv_df %>% 
  mutate(
    fit_mine = map(.x = train, ~lm(bwt ~ blength + gaweeks*bhead, data = .x)), 
    fit_length = map(.x = train, ~lm(bwt ~ blength + gaweeks, data = .x)), 
    fit_interaction = map(.x = train, ~lm(bwt ~ bhead*blength*babysex, data = .x))
  ) %>% 
  mutate(
    rmse_mine = map2_dbl(.x = fit_mine, .y = test, ~rmse(model = .x, data = .y)), 
    rmse_length = map2_dbl(.x = fit_length, .y = test, ~rmse(model = .x, data = .y)), 
    rmse_interaction = map2_dbl(.x = fit_interaction, .y = test, ~rmse(model = .x, data = .y)))
```

```{r}
cv_df %>% 
  select(.id, starts_with("rmse")) %>% 
  pivot_longer(
    rmse_mine:rmse_interaction, 
    names_to = "model", 
    values_to = "rmse", 
    names_prefix = "rmse_"
  ) %>% 
  ggplot(aes(x = model, y = rmse)) + 
  geom_boxplot()
```

## Problem 2

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

```{r}
bootstrap_weather = 
  weather_df %>% 
    bootstrap(n = 5000, id = "strap_number")

log_beta_df = 
bootstrap_weather %>% 
    mutate(
      models = map(.x = strap, ~lm(tmax ~ tmin, data = .x)), 
      results = map(models, broom::tidy), 
      glance = map(models, broom::glance))

log_beta_df %>% 
    unnest(results) %>% 
      select(strap:estimate) %>% 
  pivot_wider(names_from = "term", 
              values_from = "estimate") %>% 
  janitor::clean_names() %>% 
    mutate(log_beta = log(tmin*intercept)) %>% 
  ggplot(aes(x = log_beta)) + 
  geom_density()

r_squared_df = 
log_beta_df %>% 
    unnest(glance) %>% 
  janitor::clean_names() 


r_squared_df %>% 
  ggplot(aes(x = r_squared)) + 
  geom_density()

quantile(r_squared_df$r_squared, probs = c(0.025, 0.975), na.rm = FALSE)

```

The 95% CI for the r squared estimates is `r round(min(quantile(r_squared_df$r_squared, probs = c(0.025, 0.975), na.rm = FALSE)), digits = 3)` to `r round(max(quantile(r_squared_df$r_squared, probs = c(0.025, 0.975), na.rm = FALSE)), digits = 3)`


